<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintha Quizzes | Quiz Practices</title>
    <!-- FONT AWESOME CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- GLOBAL STYLES & FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #00aaff;
            --primary-hover: #0088cc;
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --subtle-text: #a0a0a0;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --favorite-color: #ffc107;
            --font-family: 'Poppins', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%; width: 100%; overflow: hidden;
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
        }
        
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #splash-icon { font-size: 5rem; color: var(--primary-color); margin-bottom: 20px; opacity: 0; }
        #splash-title { font-size: 2rem; color: var(--text-color); opacity: 0; text-align: center; padding: 0 15px; }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        #app-container {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; 
            perspective: 1500px;
        }

        .page {
            position: absolute; width: 90%; max-width: 1200px; padding: 40px;
            background-color: var(--surface-color); border-radius: 20px;
            box-shadow: 0 15px 30px var(--shadow-color); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; max-height: 90vh;
            transform-style: preserve-3d; backface-visibility: hidden;
            visibility: hidden; opacity: 0; transform-origin: center center;
        }
        #setup .page-content, #history .page-content { max-width: 800px; }
        .page.active { visibility: visible; }
        #quiz.page { padding-top: 100px; }

        .page-content { width: 100%; overflow-y: auto; padding-right: 15px; }
        .page-content::-webkit-scrollbar { width: 8px; }
        .page-content::-webkit-scrollbar-track { background: var(--border-color); border-radius: 4px; }

        h1, h2, h3 { color: var(--primary-color); font-weight: 600; }
        h1 { font-size: 2.5em; text-align: center; margin-bottom: 10px; }
        h2 { font-size: 2em; text-align: center; margin-bottom: 20px; }
        h3 { font-size: 1.3em; }
        p { text-align: center; color: var(--subtle-text); margin-bottom: 30px; }

        .btn {
            padding: 12px 25px; font-size: 1em; font-weight: 600; color: #fff;
            background-image: linear-gradient(45deg, var(--primary-color), #0077b3);
            border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 170, 255, 0.3); text-transform: uppercase; letter-spacing: 1px;
            display: inline-flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 170, 255, 0.5); }
        .btn-group { display: flex; gap: 20px; justify-content: center; }
        #home .btn-group .btn { flex: 1; }
        .btn.btn-secondary { background-image: none; background-color: #444; }
        
        .form-group { width: 100%; margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--subtle-text); font-weight: 400; }
        .form-control { width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1em; }
        .form-control:disabled { background-color: #2a2a2a; cursor: not-allowed; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        
        /* --- MOTIVATIONAL QUOTE STYLING --- */
        .motivation-quote {
            max-width: 700px;
            margin: 20px auto 40px auto;
            padding: 25px;
            text-align: center;
            border-left: 4px solid var(--primary-color);
            background: rgba(0,0,0,0.15);
            font-size: 1.1em;
            font-style: italic;
            line-height: 1.7;
            color: var(--text-color);
        }

        .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .loader-dual-ring { display: inline-block; width: 80px; height: 80px; }
        .loader-dual-ring:after { content: " "; display: block; width: 64px; height: 64px; margin: 8px; border-radius: 50%; border: 6px solid #fff; border-color: var(--primary-color) transparent var(--primary-color) transparent; animation: loader-dual-ring 1.2s linear infinite; }
        @keyframes loader-dual-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #quiz-top-bar { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--surface-color); box-shadow: 0 2px 10px var(--shadow-color); z-index: 100; padding: 10px 40px; display: flex; justify-content: center; align-items: center; transform: translateY(-100%); transition: transform 0.4s ease-out; }
        #quiz-top-bar.visible { transform: translateY(0); }
        #quiz-top-bar #timer { font-size: 2em; font-weight: 700; color: var(--primary-color); }
        
        #quiz-header { width: 100%; text-align: center; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; padding-bottom: 20px; }
        #quiz-topic-title { margin-bottom: 0; }
        
        #quiz-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; width: 100%; }
        .question-item { padding: 25px; border: 1px solid var(--border-color); border-radius: 10px; background: rgba(0,0,0,0.2); border-top: 4px solid var(--primary-color); display: flex; flex-direction: column; }
        .question-item h3 { margin-bottom: 20px; font-weight: 600; line-height: 1.4; color: var(--text-color); }
        .options-list { list-style-type: none; margin-top: auto; }
        .options-list li { margin-bottom: 10px; }
        .options-list label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .options-list label:hover { background-color: rgba(0, 170, 255, 0.1); border-color: var(--primary-color); }
        .options-list input[type="radio"] { display: none; }
        .options-list input[type="radio"]:checked + label { background-color: var(--primary-color); color: #fff; border-color: var(--primary-hover); }
        .option-prefix { font-weight: 700; margin-right: 10px; color: var(--primary-color); }
        .options-list input[type="radio"]:checked + label .option-prefix { color: #fff; }

        #score-display { font-size: 1.5em; text-align: center; margin-bottom: 30px; }
        #score-display span { font-size: 2em; font-weight: 700; color: var(--primary-color); }
        .result-item, .history-item { margin-bottom: 20px; padding: 20px; border-radius: 10px; background-color: rgba(0,0,0,0.15); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .result-item { flex-direction: column; align-items: flex-start; border-left: 5px solid var(--border-color); }
        .result-item.correct { border-left-color: var(--correct-color); }
        .result-item.incorrect { border-left-color: var(--incorrect-color); }
        .result-item p, .history-item-info p { text-align: left; margin-bottom: 5px; }
        .result-item .question-text, .history-item-info .topic-text { font-weight: 600; color: var(--text-color); }
        .history-item-info .date-text { font-size: 0.9em; color: var(--subtle-text); }
        .history-item-actions { display: flex; gap: 15px; align-items: center; }
        
        .btn-icon, .btn-favorite { background: none; border: none; cursor: pointer; padding: 5px; font-size: 24px; transition: all 0.2s ease; }
        .btn-icon i, .btn-favorite .fa-star { color: var(--subtle-text); }
        .btn-icon:hover i, .btn-favorite:hover .fa-star, .btn-favorite.is-favorite .fa-star { color: var(--favorite-color); }
        .btn-share i { font-size: 20px; }
        .btn-view { font-size: 0.9em; padding: 8px 18px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 900; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background: var(--surface-color); padding: 40px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; border: 1px solid var(--border-color); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        #comparison-modal .modal-content { max-width: 600px; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; margin: 20px 0; }
        .comparison-col h3 { text-align: center; margin-bottom: 10px; color: var(--text-color); }
        .comparison-col p { text-align: left; margin: 5px 0; }
        .comparison-col span { font-weight: 700; color: var(--primary-color); }
        
        #snackbar { visibility: hidden; min-width: 250px; background-color: var(--surface-color); color: #fff; text-align: center; border-radius: 8px; border: 1px solid var(--primary-color); padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 1em; }
        #snackbar.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }

        @media (max-width: 768px) {
            .page { width: 100%; height: 100%; max-height: 100vh; padding: 0; border-radius: 0; box-shadow: none; border: none; display: flex; flex-direction: column; }
            .page-content { flex-grow: 1; padding: 20px 20px 100px 20px; }
            #quiz.page { padding-top: 0; }
            #quiz .page-content { padding-top: 80px; }
            #quiz-top-bar { padding: 10px 20px; }
            #quiz-top-bar #timer { font-size: 1.6em; }
            #home .btn-group, #setup #start-quiz-btn, #quiz #submit-quiz-btn, #results #restart-quiz-btn, #history #back-home-btn {
                position: fixed; bottom: 0; left: 0; width: 100%; margin: 0; padding: 15px; background-color: var(--surface-color); border-top: 1px solid var(--border-color); box-shadow: 0 -4px 12px var(--shadow-color);
                display: flex; justify-content: center; align-items: center; gap: 15px; z-index: 100;
            }
            #setup #start-quiz-btn, #history-btn #quiz #submit-quiz-btn, #results #restart-quiz-btn, #history #back-home-btn { flex-grow: 1; max-width: 400px; }
            #splash-title { font-size: 2.5rem; }
            h1 { font-size: 2.1em; }
            h2 { font-size: 1.7em; }
            .form-row { flex-direction: column; gap: 0; }
            .history-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .question-item { padding: 15px; }
            .options-list label { padding: 15px; }
            .motivation-quote { font-size: 1em; padding: 20px; }
            .modal-content { width: 90%; padding: 30px 20px; }
            .modal-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; }
            .modal-buttons .btn { width: 100%; margin: 0; }
            .comparison-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="splash-screen"><div id="splash-icon"><i class="fa-solid fa-brain"></i></div><h1 id="splash-title">Sintha Quizzes</h1></div>
    <div id="snackbar"></div>
    <canvas id="bg-canvas"></canvas>
    <div id="quiz-top-bar"><div id="timer">00:00</div></div>
    <div id="loader-overlay" class="loader-container"><div class="loader-dual-ring"></div></div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Confirm Submission</h2>
            <p>Are you sure you want to submit?</p>
            <div class="modal-buttons">
                <button id="cancel-submit-btn" class="btn btn-secondary"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button id="confirm-submit-btn" class="btn"><i class="fa-solid fa-check"></i> Yes, Submit</button>
            </div>
        </div>
    </div>
    
    <div id="comparison-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Comparison Results</h2>
            <p>See how your score stacks up!</p>
            <div class="comparison-grid">
                <div id="sharer-results" class="comparison-col"></div>
                <div id="your-results" class="comparison-col"></div>
            </div>
            <button id="comparison-close-btn" class="btn"><i class="fa-solid fa-house"></i> Back to Home</button>
        </div>
    </div>

    <div id="app-container">
        <section id="home" class="page">
            <div class="page-content">
                <h1>Sintha Quizzes</h1>
                <p>Your ultimate AI-powered trivia challenge.</p>
                <!-- MOTIVATIONAL PARAGRAPH -->
                <p class="motivation-quote">
                    Success is not just about talent—it's about persistence, discipline, and focus. Every challenge you face is an opportunity to learn, grow, and improve. Stay committed to your goals, even when progress feels slow. Great achievements take time and consistent effort. Keep your mindset strong and your vision clear. Surround yourself with positive influences and never underestimate the power of small, daily actions. Mistakes are not failures; they are steps toward mastery. Believe in your ability to overcome obstacles and adapt. Stay professional, stay focused, and remember: resilience and hard work always pave the way to meaningful success. Keep going.
</p>
            </div>
            <div class="btn-group">
                <button id="join-quiz-btn" class="btn"><i class="fa-solid fa-wand-magic-sparkles"></i> New Quiz</button>
                <button id="history-btn" class="btn"><i class="fa-solid fa-clock-rotate-left"></i> History</button>
            </div>
        </section>

        <section id="setup" class="page">
            <div class="page-content">
                <h2 id="setup-title">Quiz Setup</h2>
                <form id="setup-form">
                    <div id="name-form-group" class="form-group"><label for="name">Your Name</label><input type="text" id="name" class="form-control" required></div>
                    <div id="quiz-config-inputs">
                        <div class="form-row">
                            <div class="form-group"><label for="num-questions">Number of Questions</label><input type="number" id="num-questions" class="form-control" value="10" min="1" max="50" required></div>
                            <div class="form-group"><label for="total-quiz-time">Total Quiz Time (minutes)</label><input type="number" id="total-quiz-time" class="form-control" value="10" min="1" max="60" required></div>
                        </div>
                        <div class="form-group"><label for="difficulty">Difficulty</label><select id="difficulty" class="form-control"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option></select></div>
                        <div class="form-group"><label for="topic">Topic</label><input type="text" id="topic" class="form-control" placeholder="e.g. The Renaissance" required></div>
                    </div>
                    <button type="submit" id="start-quiz-btn" class="btn"><i class="fa-solid fa-robot"></i> Generate Quiz</button>
                </form>
            </div>
        </section>

        <section id="quiz" class="page"><div class="page-content"><div id="quiz-header"><h2 id="quiz-topic-title">Quiz</h2></div><div id="quiz-content"></div></div><button id="submit-quiz-btn" class="btn"><i class="fa-solid fa-paper-plane"></i> Submit Quiz</button></section>
        <section id="results" class="page"><div class="page-content"><h2 id="results-title">Quiz Results</h2><div id="score-display"></div><div id="results-details"></div></div><button id="restart-quiz-btn" class="btn"><i class="fa-solid fa-house"></i> Back to Home</button></section>
        <section id="history" class="page"><div class="page-content"><h2>Quiz History</h2><div id="favorites-list"></div><div id="history-list"></div></div><button id="back-home-btn" class="btn"><i class="fa-solid fa-house"></i> Back to Home</button></section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script type="importmap">{ "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }</script>
    <script type="module">
        // ===================================================================================
        const API_KEY = "AIzaSyCRswXekCH3Yh8RhYpRGKS02J0rpKEPFcs"; // IMPORTANT: Replace with your actual Google AI API Key
        // ===================================================================================

        import { GoogleGenerativeAI } from "@google/generative-ai";
        
        const loaderOverlay = document.getElementById('loader-overlay');
        const confirmModal = document.getElementById('confirm-modal');
        const comparisonModal = document.getElementById('comparison-modal');
        const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
        const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
        const pages = { home: document.getElementById('home'), setup: document.getElementById('setup'), quiz: document.getElementById('quiz'), results: document.getElementById('results'), history: document.getElementById('history') };
        const joinQuizBtn = document.getElementById('join-quiz-btn');
        const historyBtn = document.getElementById('history-btn');
        const backHomeBtn = document.getElementById('back-home-btn');
        const setupForm = document.getElementById('setup-form');
        const quizContent = document.getElementById('quiz-content');
        const quizTopicTitle = document.getElementById('quiz-topic-title');
        const timerEl = document.getElementById('timer');
        const quizTopBar = document.getElementById('quiz-top-bar');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const resultsTitle = document.getElementById('results-title');
        const scoreDisplay = document.getElementById('score-display');
        const resultsDetails = document.getElementById('results-details');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const favoritesList = document.getElementById('favorites-list');
        const historyList = document.getElementById('history-list');
        const snackbar = document.getElementById('snackbar');
        const comparisonCloseBtn = document.getElementById('comparison-close-btn');

        let state = { name: '', numQuestions: 10, difficulty: 'Medium', topic: '', totalTime: 10, questions: [], userAnswers: [], score: 0, timerId: null, timeRemaining: 0 };
        const optionLabels = ['A', 'B', 'C', 'D'];
        let sharedQuizData = null; 
        
        const getHistory = () => JSON.parse(localStorage.getItem('quizHistory') || '[]');
        const saveHistory = (history) => localStorage.setItem('quizHistory', JSON.stringify(history));
        const getFavorites = () => JSON.parse(localStorage.getItem('quizFavorites') || '[]');
        const saveFavorites = (favorites) => localStorage.setItem('quizFavorites', JSON.stringify(favorites));
        
        function showSnackbar(message) {
            snackbar.textContent = message;
            snackbar.className = "show";
            setTimeout(() => { snackbar.className = snackbar.className.replace("show", ""); }, 3000);
        }

        function addQuizToHistory(result) {
            const history = getHistory();
            history.unshift(result);
            if (history.length > 50) history.pop();
            saveHistory(history);
        }
        function toggleFavorite(quizId) {
            let favorites = getFavorites();
            if (favorites.includes(quizId)) { favorites = favorites.filter(id => id !== quizId); } 
            else { favorites.push(quizId); }
            saveFavorites(favorites);
            renderHistoryPage();
        }
        function renderHistoryPage() {
            const history = getHistory();
            const favorites = getFavorites();
            favoritesList.innerHTML = '<h3><i class="fa-solid fa-star"></i> Favorites</h3>';
            historyList.innerHTML = '<h3><i class="fa-solid fa-clock-rotate-left"></i> Recent</h3>';

            if (history.length === 0) { historyList.innerHTML += '<p>No quiz history yet. Go play a quiz!</p>'; favoritesList.innerHTML = ''; return; }
            
            let favoritesCount = 0, historyCount = 0;
            history.forEach(quiz => {
                const isFavorite = favorites.includes(quiz.id);
                const itemHtml = `<div class="history-item"><div class="history-item-info"><p class="topic-text">${quiz.topic}</p><p>Score: ${quiz.score}/${quiz.numQuestions} • Difficulty: ${quiz.difficulty}</p><p class="date-text">${new Date(quiz.timestamp).toLocaleString()}</p></div><div class="history-item-actions"><button class="btn-icon btn-share" data-id="${quiz.id}" title="Share Results"><i class="fa-solid fa-share-nodes"></i></button><button class="btn-icon btn-favorite ${isFavorite ? 'is-favorite' : ''}" data-id="${quiz.id}" title="Toggle Favorite"><i class="fa-solid fa-star"></i></button><button class="btn btn-view" data-id="${quiz.id}">View</button></div></div>`;
                if (isFavorite) { favoritesList.innerHTML += itemHtml; favoritesCount++; } 
                else { historyList.innerHTML += itemHtml; historyCount++; }
            });

            if (favoritesCount === 0) favoritesList.innerHTML = '';
            if (historyCount === 0) historyList.innerHTML = '<h3>Recent</h3><p>No other recent quizzes.</p>';
        }
        
        async function handleHistoryClick(e) {
            const viewBtn = e.target.closest('.btn-view');
            const favBtn = e.target.closest('.btn-favorite');
            const shareBtn = e.target.closest('.btn-share');
            if (viewBtn) {
                const quizData = getHistory().find(q => q.id === Number(viewBtn.dataset.id));
                if (quizData) { renderResults(quizData); showPage('results'); }
            }
            if (favBtn) { toggleFavorite(Number(favBtn.dataset.id)); }
            if (shareBtn) {
                const quizData = getHistory().find(q => q.id === Number(shareBtn.dataset.id));
                if (quizData) {
                    const encodedData = btoa(JSON.stringify(quizData));
                    const shareUrl = `${window.location.origin}${window.location.pathname}#quiz-share-${encodedData}`;
                    const sharePayload = { title: 'Sintha Quiz Challenge', text: `I scored ${quizData.score}/${quizData.numQuestions} on a quiz about ${quizData.topic}! Can you beat my score?`, url: shareUrl };
                    if (navigator.share) {
                        try { await navigator.share(sharePayload); } 
                        catch (err) { console.error('Share failed:', err); }
                    } else {
                        navigator.clipboard.writeText(shareUrl);
                        showSnackbar("Quiz link copied to clipboard!");
                    }
                }
            }
        }
        
        function doSubmit() {
            hideConfirmModal();
            clearInterval(state.timerId);
            state.score = 0;
            state.userAnswers = [];
            state.questions.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                const answer = selectedOption ? parseInt(selectedOption.value) : -1;
                state.userAnswers.push(answer);
                if (answer === q.answer) state.score++;
            });
            const quizResult = { 
                id: Date.now(), name: state.name, topic: state.topic, difficulty: state.difficulty, 
                numQuestions: state.numQuestions, score: state.score, questions: state.questions, 
                userAnswers: state.userAnswers, timestamp: Date.now(), totalTime: state.totalTime
            };
            
            if (sharedQuizData) {
                showComparisonResults(quizResult);
            } else {
                addQuizToHistory(quizResult);
                renderResults(quizResult);
                showPage('results');
            }
        }

        function showComparisonResults(yourResult) {
            const sharerCol = document.getElementById('sharer-results');
            const yourCol = document.getElementById('your-results');
            
            sharerCol.innerHTML = `<h3>${sharedQuizData.name}</h3><p>Topic: <span>${sharedQuizData.topic}</span></p><p>Score: <span>${sharedQuizData.score} / ${sharedQuizData.numQuestions}</span></p>`;
            yourCol.innerHTML = `<h3>${yourResult.name} (You)</h3><p>Topic: <span>${yourResult.topic}</span></p><p>Score: <span>${yourResult.score} / ${yourResult.numQuestions}</span></p>`;
            comparisonModal.classList.add('visible');
        }

        function renderQuiz() {
            quizTopicTitle.textContent = `${state.topic}`;
            quizContent.innerHTML = '';
            state.questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'question-item';
                questionEl.innerHTML = `<h3>${index + 1}. ${q.question}</h3><ul class="options-list">${q.options.map((opt, i) => `<li><input type="radio" name="q${index}" id="q${index}o${i}" value="${i}"><label for="q${index}o${i}"><span class="option-prefix">${optionLabels[i]}</span>${opt}</label></li>`).join('')}</ul>`;
                quizContent.appendChild(questionEl);
            });
        }
        
        function renderResults(resultData) {
            resultsTitle.textContent = `Results for ${resultData.name}`;
            scoreDisplay.innerHTML = `You scored <span>${resultData.score}/${resultData.numQuestions}</span>`;
            resultsDetails.innerHTML = '';
            resultData.questions.forEach((q, index) => {
                const userAnswerIndex = resultData.userAnswers[index];
                const isCorrect = userAnswerIndex === q.answer;
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
                let userAnswerText = 'Not answered';
                if (userAnswerIndex > -1 && q.options[userAnswerIndex]) { userAnswerText = q.options[userAnswerIndex]; }
                resultItem.innerHTML = `<p class="question-text">${index + 1}. ${q.question}</p><p class="result-answer">Your answer: ${userAnswerText}</p>${!isCorrect ? `<p class="result-answer correct-answer">Correct answer: ${q.options[q.answer]}</p>` : ''}`;
                resultsDetails.appendChild(resultItem);
            });
            gsap.from(".result-item", { duration: 0.5, opacity: 0, x: -50, stagger: 0.1, ease: 'power2.out' });
        }
        
        async function handleSetupSubmit(e) {
            e.preventDefault();
            const nameInput = document.getElementById('name');
            state.name = nameInput.value.trim();
            if (!state.name) { showSnackbar("Your name is required."); return; }
            localStorage.setItem('quizUserName', state.name);

            if (sharedQuizData) {
                state.topic = sharedQuizData.topic;
                state.questions = sharedQuizData.questions;
                state.numQuestions = sharedQuizData.numQuestions;
                state.difficulty = sharedQuizData.difficulty;
                state.totalTime = sharedQuizData.totalTime;
                
                renderQuiz();
                showPage('quiz');
                startTimer();
                return;
            }

            if (API_KEY === "YOUR_GOOGLE_AI_API_KEY") { alert("Please enter your Google AI API Key at the top of the script."); return; }
            state.numQuestions = parseInt(document.getElementById('num-questions').value) || 10;
            state.totalTime = parseInt(document.getElementById('total-quiz-time').value) || 10;
            state.difficulty = document.getElementById('difficulty').value;
            state.topic = document.getElementById('topic').value.trim();
            if (!state.topic) { showSnackbar("Topic is required."); return; }

            loaderOverlay.style.display = 'flex';
            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = `Generate a valid JSON array of ${state.numQuestions} multiple-choice quiz questions about "${state.topic}" with ${state.difficulty} difficulty. Each object must have keys: "question", "options" (array of 4 strings), and "answer" (0-indexed integer of correct option). The entire output must be only the raw JSON array.`;
                const result = await model.generateContent(prompt);
                const response = await result.response;
                state.questions = JSON.parse(response.text().replace(/```json/g, '').replace(/```/g, '').trim());
                if (!Array.isArray(state.questions) || state.questions.length === 0) { throw new Error("AI returned invalid data."); }
                
                processAndShuffleQuestions();
                renderQuiz();
                showPage('quiz');
                startTimer();
            } catch (error) { console.error("Error generating quiz:", error); alert(`Failed to generate quiz. Check the console (F12) for details.\nError: ${error.message}`);
            } finally { loaderOverlay.style.display = 'none'; }
        }
        
        function processAndShuffleQuestions() {
            state.questions.forEach(q => {
                const correctAnswerText = q.options[q.answer];
                for (let i = q.options.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [q.options[i], q.options[j]] = [q.options[j], q.options[i]]; }
                q.answer = q.options.findIndex(option => option === correctAnswerText);
            });
        }
        
        function startTimer() {
            state.timeRemaining = state.totalTime * 60;
            updateTimerDisplay();
            if (state.timerId) clearInterval(state.timerId);
            state.timerId = setInterval(() => {
                state.timeRemaining--;
                updateTimerDisplay();
                if (state.timeRemaining <= 0) { timerEl.textContent = "Time's Up!"; clearInterval(state.timerId); setTimeout(doSubmit, 1500); }
            }, 1000);
        }
        function updateTimerDisplay(){
            const minutes = Math.floor(state.timeRemaining / 60);
            const seconds = state.timeRemaining % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }
        
        function hideConfirmModal(){ confirmModal.classList.remove("visible"); }

        function showPage(pageId){
            const activePage = document.querySelector(".page.active");
            const newPage = pages[pageId];
            if (activePage === newPage) return;

            if (pageId === 'quiz') { quizTopBar.classList.add('visible'); } 
            else { quizTopBar.classList.remove('visible'); }

            const tl = gsap.timeline({ onComplete: () => { 
                if (activePage) activePage.classList.remove('active'); 
                newPage.classList.add('active'); 
                gsap.set(activePage, { autoAlpha: 0 }); 
            } });
            if (activePage) { tl.to(activePage, { rotationY: 90, scale: 0.9, autoAlpha: 0, duration: 0.5, ease: 'power3.in' }); }
            tl.fromTo(newPage, { rotationY: -90, scale: 0.9, autoAlpha: 1 }, { rotationY: 0, scale: 1, duration: 0.5, ease: 'power3.out' });
        }
        
        let scene, camera, renderer, shapes = [];
        function initThree(){
            scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.z = 15;
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            const geometries = [ new THREE.TetrahedronGeometry(0.4), new THREE.OctahedronGeometry(0.3), new THREE.DodecahedronGeometry(0.5) ];
            const material = new THREE.MeshStandardMaterial({ color: 0x00aaff, metalness: 0.2, roughness: 0.6, transparent: true, opacity: 0.2 });
            for (let i = 0; i < 100; i++) { const shape = new THREE.Mesh(geometries[i % geometries.length], material); shape.position.set( (Math.random() - 0.5) * 30, (Math.random() - 0.5) * 30, (Math.random() - 0.5) * 30 ); shape.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI); shape.userData.rotSpeed = new THREE.Vector3( (Math.random() - 0.5) * 0.01, (Math.random() - 0.5) * 0.01, (Math.random() - 0.5) * 0.01 ); shapes.push(shape); scene.add(shape); }
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00aaff, transparent: true, opacity: 0.05 });
            for(let i = 0; i < 50; i++) { const p1 = shapes[Math.floor(Math.random() * shapes.length)].position; const p2 = shapes[Math.floor(Math.random() * shapes.length)].position; const lineGeometry = new THREE.BufferGeometry().setFromPoints([p1, p2]); const line = new THREE.Line(lineGeometry, lineMaterial); scene.add(line); }
            scene.add(new THREE.AmbientLight(0xffffff, 0.5)); const pointLight = new THREE.PointLight(0xffffff, 0.8); pointLight.position.set(10, 10, 10); scene.add(pointLight);
            animateThree();
        }
        function animateThree(){ requestAnimationFrame(animateThree); const time = Date.now() * 0.0001; camera.position.x = 10 * Math.cos(time); camera.position.z = 10 * Math.sin(time); camera.lookAt(scene.position); shapes.forEach(shape => { shape.rotation.x += shape.userData.rotSpeed.x; shape.rotation.y += shape.userData.rotSpeed.y; shape.rotation.z += shape.userData.rotSpeed.z; }); renderer.render(scene, camera); }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        function setQuizConfigInputs(enabled) {
            const inputs = document.querySelectorAll('#quiz-config-inputs .form-control');
            inputs.forEach(input => {
                input.disabled = !enabled;
                if (input.type !== 'select-one') {
                   input.required = enabled;
                }
            });
        }

        function prepareForNewQuiz() {
            sharedQuizData = null;
            document.getElementById('quiz-config-inputs').style.display = 'block';
            document.getElementById('setup-title').textContent = 'Quiz Setup';
            document.getElementById('start-quiz-btn').innerHTML = `<i class="fa-solid fa-robot"></i> Generate Quiz`;
            setQuizConfigInputs(true); // Enable inputs
            document.getElementById('name').value = localStorage.getItem('quizUserName') || '';
            document.getElementById('topic').value = ''; // Clear topic field
            showPage('setup');
        }

        function prepareForChallengeQuiz() {
            document.getElementById('setup-title').textContent = `Challenge from ${sharedQuizData.name}`;
            document.getElementById('quiz-config-inputs').style.display = 'none';
            document.getElementById('start-quiz-btn').innerHTML = `<i class="fa-solid fa-play"></i> Start Challenge`;
            setQuizConfigInputs(false); // Disable inputs to fix submission bug
            document.getElementById('name').value = localStorage.getItem('quizUserName') || '';
            showPage('setup');
        }

        joinQuizBtn.addEventListener('click', prepareForNewQuiz);
        historyBtn.addEventListener('click', () => { renderHistoryPage(); showPage('history'); });
        backHomeBtn.addEventListener('click', () => showPage('home'));
        setupForm.addEventListener('submit', handleSetupSubmit);
        submitQuizBtn.addEventListener('click', () => confirmModal.classList.add('visible'));
        confirmSubmitBtn.addEventListener('click', doSubmit);
        cancelSubmitBtn.addEventListener('click', hideConfirmModal);
        confirmModal.addEventListener('click', (e) => { if(e.target === confirmModal) hideConfirmModal(); });
        restartQuizBtn.addEventListener('click', () => showPage('home'));
        favoritesList.addEventListener('click', handleHistoryClick);
        historyList.addEventListener('click', handleHistoryClick);
        comparisonCloseBtn.addEventListener('click', () => { comparisonModal.classList.remove('visible'); showPage('home'); });

        document.addEventListener('DOMContentLoaded', () => { 
            try {
                const splashTl = gsap.timeline({
                    onComplete: () => {
                        initThree();
                        if (window.location.hash.startsWith('#quiz-share-')) {
                            try {
                                const encodedData = window.location.hash.substring(12);
                                sharedQuizData = JSON.parse(atob(encodedData));
                                window.location.hash = ''; // Clear hash
                                prepareForChallengeQuiz();
                            } catch (e) {
                                console.error('Failed to decode shared quiz:', e);
                                showPage('home');
                            }
                        } else {
                           showPage('home');
                        }
                    }
                });
                splashTl
                    .to("#splash-icon", { duration: 1, autoAlpha: 1, scale: 1, ease: 'back.out(1.7)' })
                    .to("#splash-title", { duration: 0.8, autoAlpha: 1, scale: 1, ease: 'back.out(1.7)' }, "-=0.7")
                    .to("#splash-screen", { duration: 0.8, autoAlpha: 0, delay: 1, onComplete: () => { document.getElementById('splash-screen').style.display = 'none'; } });
            } catch(e) { console.error("Initialization failed:", e); document.body.innerHTML = '<h1>A critical error occurred. Please refresh the page.</h1>'; } 
        });
    </script>
</body>
</html>
