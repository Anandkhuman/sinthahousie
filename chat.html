<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid P2P Chat</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- CSS STYLES EMBEDDED -->
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary-color: #0d47a1;
            --secondary-color: #bb86fc;
            --text-color: #e0e0e0;
            --input-bg: #2c2c2c;
            --font-family: 'Poppins', sans-serif;
            --success-color: #03dac6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #bg { position: fixed; top: 0; left: 0; z-index: -1; }
        .app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .screen {
            display: none;
            width: 100%;
            max-width: 420px;
            opacity: 0;
            transform: scale(0.95);
        }
        .screen.active { display: block; opacity: 1; transform: scale(1); }
        .card {
            background-color: var(--card-bg);
            padding: 30px 35px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 1px solid #333;
        }
        h1, h2, h3 { color: white; margin-bottom: 10px; }
        p { margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6; color: #b0b0b0; }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus { outline: none; border-color: var(--secondary-color); }
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--secondary-color);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { background-color: #d1a5ff; }
        button:active { transform: scale(0.98); }
        button#create-room-btn { background-color: var(--success-color); }
        button#create-room-btn:hover { background-color: #36fddc; }
        .divider { margin: 20px 0; font-weight: bold; color: #555; position: relative; }
        .divider::before, .divider::after {
            content: ''; position: absolute; top: 50%; width: 40%; height: 1px; background: #444;
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        
        .name-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .name-container .edit-name-btn { all: unset; cursor: pointer; color: #888; transition: color 0.3s; }
        .name-container .edit-name-btn:hover { color: var(--secondary-color); }
        
        .room-code-container { margin-top: 20px; padding: 15px; background-color: var(--input-bg); border-radius: 8px; text-align: left; }
        .code-box {
            background: var(--bg-color); padding: 10px; border-radius: 5px; word-wrap: break-word;
            margin: 10px 0; font-weight: bold; text-align: center;
            border: 1px dashed var(--secondary-color); user-select: all;
        }
        .room-actions { display: flex; gap: 10px; margin-top: 10px; }
        .room-actions button { width: 50%; padding: 8px 15px; font-size: 0.8rem; }
        #copy-code-btn { background-color: var(--primary-color); color: white; }
        #copy-code-btn:hover { background-color: #1e5abc; }
        
        .chat-container {
            width: 100%; max-width: 700px; height: 90vh; background: var(--card-bg);
            border-radius: 15px; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333;
        }
        .chat-header {
            padding: 15px 20px; background: #2a2a2a; border-radius: 15px 15px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        #leave-btn { width: auto; padding: 8px 20px; font-size: 0.9rem; background: #c62828; color: white; }
        #leave-btn:hover { background: #e53935; }
        .messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 1px; }
        .messages::-webkit-scrollbar { width: 8px; }
        .messages::-webkit-scrollbar-track { background: var(--card-bg); }
        .messages::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        .message { margin-bottom: 15px; max-width: 75%; display: flex; flex-direction: column; }
        .message.sent { align-self: flex-end; align-items: flex-end; }
        .message.received { align-self: flex-start; align-items: flex-start; }
        .message .sender-name { font-size: 0.75rem; color: #aaa; margin-bottom: 4px; margin-left: 12px; margin-right: 12px; }
        .message-bubble { padding: 10px 15px; border-radius: 20px; line-height: 1.4; word-wrap: break-word; }
        .message.sent .message-bubble { background: var(--primary-color); color: white; border-bottom-right-radius: 5px; }
        .message.received .message-bubble { background: #363636; color: var(--text-color); border-bottom-left-radius: 5px; }
        .message.system { align-self: center; text-align: center; font-style: italic; color: #888; font-size: 0.8rem; background: #2c2c2c; padding: 5px 15px; border-radius: 20px; }
        .chat-input-form { display: flex; padding: 15px; border-top: 1px solid #333; gap: 10px; }
        .chat-input-form input { margin-bottom: 0; }
        .chat-input-form button { width: auto; padding: 0 25px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center;
            align-items: center; z-index: 1000; color: white; font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <canvas id="bg"></canvas>
    <div class="loading-overlay" id="loading-overlay">Connecting...</div>
    <div class="app-container">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen">
            <div class="card">
                <h1><i class="fas fa-comments" style="color: var(--secondary-color);"></i> Fluid Chat</h1>
                <p>A decentralized, peer-to-peer chat application. Your conversations are private and never touch a central server.</p>
                <form id="name-form">
                    <input type="text" id="name-input" placeholder="Enter Your Name" required autocomplete="off">
                    <button type="submit">Continue <i class="fas fa-arrow-right"></i></button>
                </form>
            </div>
        </div>
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <div class="card">
                <div class="name-container">
                    <h2 id="welcome-message"></h2>
                    <button class="edit-name-btn" id="edit-name-btn" title="Edit Name"><i class="fas fa-pencil-alt"></i></button>
                </div>
                <button id="create-room-btn">Create a New Room <i class="fas fa-plus-circle"></i></button>
                <div class="divider">OR</div>
                <form id="join-form">
                    <input type="text" id="join-code-input" placeholder="Enter Room Code" required autocomplete="off">
                    <button type="submit">Join Room <i class="fas fa-sign-in-alt"></i></button>
                </form>
                <div id="room-code-display" class="room-code-container" style="display: none;">
                    <p>Your room is ready! Share this code:</p>
                    <div id="room-code" class="code-box"></div>
                    <div class="room-actions">
                        <button id="share-btn"><i class="fas fa-share-alt"></i> Share Link</button>
                        <button id="copy-code-btn"><i class="fas fa-copy"></i> Copy Code</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chat Screen -->
        <div id="chat-screen" class="screen">
            <div class="chat-container">
                <div class="chat-header">
                    <h3 id="chat-room-title">Chat Room</h3>
                    <button id="leave-btn"><i class="fas fa-sign-out-alt"></i> Leave</button>
                </div>
                <div class="messages" id="message-container"></div>
                <form class="chat-input-form" id="chat-form">
                    <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit">Send <i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <!-- EXTERNAL LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <!-- JAVASCRIPT LOGIC -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            lobby: document.getElementById('lobby-screen'),
            chat: document.getElementById('chat-screen'),
        };
        const loadingOverlay = document.getElementById('loading-overlay');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name-input');
        const welcomeMessage = document.getElementById('welcome-message');
        const editNameBtn = document.getElementById('edit-name-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinForm = document.getElementById('join-form');
        const joinCodeInput = document.getElementById('join-code-input');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const roomCodeEl = document.getElementById('room-code');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const shareBtn = document.getElementById('share-btn');
        const messageContainer = document.getElementById('message-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const leaveBtn = document.getElementById('leave-btn');

        // --- App State ---
        let peer;
        let username = '';
        let currentRoomId = null;
        let connections = {};
        let roomToJoinFromUrl = null;

        // --- GSAP Timeline & UI Functions ---
        const tl = gsap.timeline({ defaults: { duration: 0.4, ease: "power2.inOut" }});
        const showScreen = (screen) => {
            const currentActive = document.querySelector('.screen.active');
            if (currentActive) {
                tl.to(currentActive, { opacity: 0, scale: 0.95, onComplete: () => currentActive.classList.remove('active') });
            }
            tl.to(screen, { opacity: 1, scale: 1, onComplete: () => screen.classList.add('active') }, currentActive ? ">-0.2" : ">");
        };
        const showLoading = (show) => loadingOverlay.style.display = show ? 'flex' : 'none';

        // --- 1. Three.js Background ---
        (() => {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg'), antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.z = 2;
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 8000;
            const posArray = new Float32Array(starCount * 3);
            for (let i = 0; i < starCount * 3; i++) posArray[i] = (Math.random() - 0.5) * (Math.random() * 50);
            starGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const starMaterial = new THREE.PointsMaterial({ size: 0.008, color: 0xbb86fc, transparent: true, opacity: 0.8 });
            const starMesh = new THREE.Points(starGeometry, starMaterial);
            scene.add(starMesh);
            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', e => {
                mouseX = (e.clientX - window.innerWidth / 2) / 100;
                mouseY = (e.clientY - window.innerHeight / 2) / 100;
            });
            const animate = () => {
                requestAnimationFrame(animate);
                starMesh.rotation.y += 0.0001;
                camera.position.x += (mouseX - camera.position.x) * 0.01;
                camera.position.y += (-mouseY - camera.position.y) * 0.01;
                camera.lookAt(scene.position);
                renderer.render(scene, camera);
            };
            animate();
            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });
        })();

        // --- 2. Initialization and Name Handling ---
        const initialize = () => {
            const urlParams = new URLSearchParams(window.location.search);
            roomToJoinFromUrl = urlParams.get('room');
            const savedName = localStorage.getItem('fluid-chat-username');
            if (savedName) {
                username = savedName;
                initLobby();
            } else {
                screens.welcome.classList.add('active');
            }
        };

        nameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            if (name) {
                username = name;
                localStorage.setItem('fluid-chat-username', username);
                initLobby();
            }
        });

        const initLobby = () => {
            welcomeMessage.textContent = `Welcome, ${username}!`;
            showScreen(screens.lobby);
            initPeer();
        };

        editNameBtn.addEventListener('click', () => {
            const newName = prompt("Enter your new name:", username);
            if (newName && newName.trim() !== "" && newName.trim() !== username) {
                const oldName = username;
                username = newName.trim();
                localStorage.setItem('fluid-chat-username', username);
                welcomeMessage.textContent = `Welcome, ${username}!`;
                broadcast({ type: 'name-change', oldName, newName: username });
                const systemMessage = {type: 'system', content: `${oldName} is now known as ${username}.`};
                displayMessage(systemMessage);
                saveMessageToHistory(systemMessage);
            }
        });

        // --- 3. PeerJS & Core Connection Logic ---
        const initPeer = () => {
            if (peer) peer.destroy();
            peer = new Peer();
            peer.on('open', id => {
                console.log('My PeerJS ID is:', id);
                // If a room was specified in the URL, try to join it now that we have a Peer ID.
                if (roomToJoinFromUrl) {
                    joinRoom(roomToJoinFromUrl);
                    roomToJoinFromUrl = null; // Consume it
                }
            });
            peer.on('connection', handleNewConnection);
            peer.on('error', err => {
                console.error('PeerJS error:', err);
                alert(`A connection error occurred: ${err.message}. Please refresh.`);
                showLoading(false);
            });
        };

        const handleNewConnection = (conn) => {
            showLoading(true);
            conn.on('open', () => {
                connections[conn.peer] = conn;
                // When a new person connects, the host moves to the chat screen
                if (!screens.chat.classList.contains('active')) {
                    currentRoomId = peer.id; // The host's ID is the room ID
                    showScreen(screens.chat);
                    loadChatHistory(); // Host loads their own history
                    const systemMessage = {type: 'system', content: `You created the room. Share code: ${currentRoomId}`};
                    displayMessage(systemMessage);
                    saveMessageToHistory(systemMessage);
                }
                conn.send({ type: 'history-request', peerId: peer.id });
                showLoading(false);
            });
            conn.on('data', data => handleData(data, conn.peer));
            conn.on('close', () => handleDisconnect(conn.peer));
        };
        
        const handleData = (data, peerId) => {
            switch (data.type) {
                case 'message': case 'system': case 'name-change':
                    displayMessage(data);
                    saveMessageToHistory(data);
                    if (data.type === 'name-change' && connections[peerId]) {
                        connections[peerId].username = data.newName;
                    }
                    break;
                case 'history-request':
                    connections[peerId].send({ type: 'user-info', username: username });
                    connections[peerId].send({ type: 'history-sync', history: getChatHistory() });
                    const welcomeMsg = { type: 'system', content: `${username} has joined!` };
                    broadcast(welcomeMsg);
                    displayMessage(welcomeMsg);
                    saveMessageToHistory(welcomeMsg);
                    break;
                case 'history-sync':
                    loadChatHistory(data.history);
                    break;
                case 'user-info':
                    if (connections[peerId]) connections[peerId].username = data.username;
                    const joinMsg = { type: 'system', content: `${data.username} has joined!` };
                    displayMessage(joinMsg);
                    saveMessageToHistory(joinMsg);
                    break;
            }
        };

        const handleDisconnect = (peerId) => {
            const disconnectedUser = connections[peerId]?.username || 'A user';
            const systemMessage = { type: 'system', content: `${disconnectedUser} has left.` };
            displayMessage(systemMessage);
            saveMessageToHistory(systemMessage);
            delete connections[peerId];
        };

        const broadcast = (data) => {
            Object.values(connections).forEach(conn => conn.open && conn.send(data));
        };

        // --- 4. Room Management (Create, Join, Share) ---
        createRoomBtn.addEventListener('click', () => {
            if (!peer || peer.disconnected) {
                alert('Connection not established. Please wait a moment.');
                return;
            }
            currentRoomId = peer.id;
            roomCodeEl.textContent = currentRoomId;
            roomCodeDisplay.style.display = 'block';
            gsap.from(roomCodeDisplay, { opacity: 0, y: 20, duration: 0.3 });
            // The host now waits for a connection to be moved to the chat screen.
        });

        joinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = joinCodeInput.value.trim();
            if (code) joinRoom(code);
        });

        const joinRoom = (code) => {
            if (!peer || peer.disconnected) {
                alert('Connection not established. Please wait a moment.');
                return;
            }
            if (code === peer.id) {
                alert("You can't join your own room code.");
                return;
            }
            showLoading(true);
            const conn = peer.connect(code);
            conn.on('open', () => {
                connections[conn.peer] = conn;
                currentRoomId = code;
                showScreen(screens.chat);
                conn.send({ type: 'user-info', username: username });
                // History will be sent by the host upon receiving user-info
            });
            conn.on('data', data => handleData(data, conn.peer));
            conn.on('close', () => handleDisconnect(conn.peer));
            conn.on('error', err => {
                alert("Failed to connect to room. The code might be invalid or the host has left.");
                console.error(err);
                showLoading(false);
            });
        };

        shareBtn.addEventListener('click', () => {
            const shareUrl = `${window.location.origin}${window.location.pathname}?room=${currentRoomId}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                shareBtn.innerHTML = '<i class="fas fa-check"></i> Link Copied!';
                setTimeout(() => shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share Link', 2000);
            });
        });
        
        copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoomId).then(() => {
                copyCodeBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => copyCodeBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Code', 2000);
            });
        });

        // --- 5. Chat & Message History Logic ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const content = chatInput.value.trim();
            if (content) {
                const message = { type: 'message', sender: username, content };
                broadcast(message);
                displayMessage(message);
                saveMessageToHistory(message);
                chatInput.value = '';
            }
        });

        const displayMessage = (msg) => {
            const div = document.createElement('div');
            div.classList.add('message');
            if (msg.type === 'system') {
                div.classList.add('system');
                div.textContent = msg.content;
            } else if (msg.type === 'name-change') {
                div.classList.add('system');
                div.textContent = `${msg.oldName} is now known as ${msg.newName}.`;
            } else {
                div.classList.add(msg.sender === username ? 'sent' : 'received');
                div.innerHTML = `<div class="sender-name">${msg.sender}</div><div class="message-bubble">${msg.content}</div>`;
            }
            messageContainer.appendChild(div);
            gsap.from(div, { opacity: 0, y: 10, duration: 0.3 });
            messageContainer.scrollTop = messageContainer.scrollHeight;
        };

        const getChatHistoryKey = () => `chat-history-${currentRoomId}`;
        const saveMessageToHistory = (message) => {
            if (!currentRoomId) return;
            const history = getChatHistory();
            history.push(message);
            localStorage.setItem(getChatHistoryKey(), JSON.stringify(history.slice(-100))); // Save last 100 messages
        };
        const getChatHistory = () => {
            if (!currentRoomId) return [];
            return JSON.parse(localStorage.getItem(getChatHistoryKey()) || '[]');
        };
        const loadChatHistory = (history = null) => {
            const chatHistory = history || getChatHistory();
            messageContainer.innerHTML = '';
            chatHistory.forEach(msg => displayMessage(msg));
            if (history) { // If we received history from a peer, save it
                localStorage.setItem(getChatHistoryKey(), JSON.stringify(chatHistory.slice(-100)));
            }
        };

        leaveBtn.addEventListener('click', () => {
            Object.values(connections).forEach(conn => conn.close());
            connections = {};
            currentRoomId = null;
            messageContainer.innerHTML = '';
            roomCodeDisplay.style.display = 'none';
            joinCodeInput.value = '';
            history.pushState(null, '', window.location.pathname); // Clear URL params
            showScreen(screens.lobby);
        });

        // --- Start the App ---
        initialize();
    });
    </script>
</body>
</html>
